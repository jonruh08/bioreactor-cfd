# OpenFOAM Bioreactor CFD - Complete Workflow Guide

*Created: October 21, 2025*

## Table of Contents
1. [Project Overview](#project-overview)
2. [Standard Workflow](#standard-workflow)
3. [Case Structure](#case-structure)
4. [Step-by-Step Process](#step-by-step-process)
5. [Key Files Reference](#key-files-reference)
6. [Debugging Guide](#debugging-guide)
7. [Independence Checklist](#independence-checklist)

---

## Project Overview

### Phase 1: Basic Stirred Tank (Current)

**Geometry:**
- Cylindrical tank: 0.3m diameter, 0.3m height
- Simplified impeller as rotating zone (no actual blades yet)
- Single phase (water only)
- No baffles initially

**Physics:**
- Steady-state simulation
- RANS turbulence (k-ω SST)
- MRF (Multiple Reference Frame) for rotation
- 100 RPM impeller speed

**Validation:**
- Calculate power number: Np = P/(ρ N³ D⁵)
- Compare to literature correlations
- Mesh independence study

**Deliverable:**
- Working case that runs to convergence
- Validated results
- Documentation
- Committed to GitHub

---

## Standard Workflow

### The Six-Step Process (Same for Every Case)
```
1. GEOMETRY → 2. MESH → 3. SETUP → 4. RUN → 5. POST-PROCESS → 6. VALIDATE
```

### Quick Reference

| Step | Tools | Output | Time |
|------|-------|--------|------|
| 1. Geometry | Paper sketch, FreeCAD | STL files, sketches | 30 min |
| 2. Mesh | blockMesh, snappyHexMesh | polyMesh/ | 15 min |
| 3. Setup | Text editor | 0/, constant/, system/ | 45 min |
| 4. Run | simpleFoam, pimpleFoam | Time directories | Hours |
| 5. Post-process | ParaView, Python | Plots, metrics | 30 min |
| 6. Validate | Python, literature | Validation report | 30 min |

---

## Case Structure

### Standard Directory Layout
```
case_name/
├── 0.orig/              # Original initial conditions (template)
│   ├── U                # Velocity field
│   ├── p                # Pressure field
│   ├── k                # Turbulent kinetic energy
│   ├── omega            # Specific dissipation rate
│   └── nut              # Turbulent viscosity
├── 0/                   # Actual initial conditions (copied from 0.orig)
├── constant/            # Time-independent data
│   ├── polyMesh/        # Mesh (generated by blockMesh)
│   ├── transportProperties
│   ├── turbulenceProperties
│   └── MRFProperties    # If using rotating zones
├── system/              # Simulation control
│   ├── controlDict      # Time control, I/O
│   ├── fvSchemes        # Discretization schemes
│   ├── fvSolution       # Linear solvers, algorithms
│   └── blockMeshDict    # Mesh generation (for blockMesh)
├── Allrun               # Script to run entire case
├── Allclean             # Script to clean case
└── README.md            # Case documentation
```

---

## Step-by-Step Process

### 1. Geometry Definition

**Purpose:** Define the physical domain to simulate

**For Simple Cases (blockMesh):**
1. Sketch geometry on paper
2. Identify key vertices (corners)
3. Define blocks connecting vertices
4. Label boundaries (inlet, outlet, walls)
5. Write `system/blockMeshDict`

**For Complex Cases (STL + snappyHexMesh):**
1. Create geometry in FreeCAD
2. Export as STL format
3. Place in `constant/geometry/`
4. Configure `system/snappyHexMeshDict`

**Key Principle:** Start simple! Simplify geometry while capturing essential physics.

---

### 2. Mesh Generation

**Purpose:** Discretize continuous domain into discrete cells

**Commands:**
```bash
blockMesh                    # Generate structured mesh
checkMesh                    # Verify quality
checkMesh -allTopology       # Detailed check
paraFoam                     # Visualize mesh
```

**Quality Metrics to Check:**
- ✅ Max non-orthogonality < 70
- ✅ Max skewness < 4  
- ✅ No negative volumes
- ✅ Aspect ratio reasonable

**Mesh Sizes:**
- Development/debug: 10k - 50k cells
- Production: 100k - 1M cells
- High accuracy: 1M+ cells

**Tips:**
- Refine where gradients are high (near walls, impeller)
- Keep coarse in bulk regions
- Always do mesh independence study

---

### 3. Case Setup

**Purpose:** Define physics, initial conditions, boundary conditions

#### 3a. Initial Conditions (0.orig/)

**Velocity (U):**
```cpp
dimensions      [0 1 -1 0 0 0 0];  // m/s
internalField   uniform (0 0 0);   // Start from rest

boundaryField
{
    walls
    {
        type    noSlip;            // Zero velocity at walls
    }
    
    inlet
    {
        type    fixedValue;
        value   uniform (0.1 0 0); // 0.1 m/s in x-direction
    }
    
    outlet
    {
        type    zeroGradient;      // Fully developed flow
    }
}
```

**Pressure (p):**
```cpp
dimensions      [0 2 -2 0 0 0 0];  // m²/s² (kinematic)
internalField   uniform 0;          // Relative pressure

boundaryField
{
    walls
    {
        type    zeroGradient;
    }
    
    outlet
    {
        type    fixedValue;
        value   uniform 0;          // Reference pressure
    }
}
```

**Turbulence (k, omega):**
```cpp
// k (turbulent kinetic energy)
dimensions      [0 2 -2 0 0 0 0];
internalField   uniform 0.001;      // Small initial value

// omega (specific dissipation rate)
dimensions      [0 0 -1 0 0 0 0];
internalField   uniform 1;          // Typical initial value
```

#### 3b. Physical Properties (constant/)

**transportProperties:**
```cpp
transportModel  Newtonian;
nu              1e-06;              // Water kinematic viscosity (m²/s)
```

**turbulenceProperties:**
```cpp
simulationType  RAS;                // Reynolds-Averaged Simulation

RAS
{
    RASModel        kOmegaSST;      // Turbulence model
    turbulence      on;
    printCoeffs     on;
}
```

**MRFProperties** (if using rotating zones):
```cpp
MRF1
{
    cellZone    rotor;              // Name of rotating zone
    active      yes;
    
    nonRotatingPatches ();          // Patches that don't rotate
    
    origin      (0 0 0);            // Rotation axis origin
    axis        (0 0 1);            // Rotation axis direction
    omega       10.47;              // Angular velocity (rad/s) = 100 RPM
}
```

#### 3c. Solver Control (system/)

**controlDict:**
```cpp
application     simpleFoam;         // Solver name

startFrom       startTime;
startTime       0;
stopAt          endTime;
endTime         1000;               // Iterations (steady-state)

deltaT          1;                  // Time step

writeControl    timeStep;
writeInterval   100;                // Write every 100 iterations

writeFormat     binary;             // Smaller file size
writeCompression off;

timeFormat      general;
timePrecision   6;

runTimeModifiable true;
```

**fvSchemes:**
```cpp
ddtSchemes
{
    default         steadyState;    // For steady simulations
}

gradSchemes
{
    default         Gauss linear;
    grad(U)         Gauss linear;
}

divSchemes
{
    default         none;
    div(phi,U)      bounded Gauss linearUpwind grad(U);
    div(phi,k)      bounded Gauss upwind;
    div(phi,omega)  bounded Gauss upwind;
    div((nuEff*dev2(T(grad(U))))) Gauss linear;
}

laplacianSchemes
{
    default         Gauss linear corrected;
}

interpolationSchemes
{
    default         linear;
}

snGradSchemes
{
    default         corrected;
}
```

**fvSolution:**
```cpp
solvers
{
    p
    {
        solver          GAMG;
        tolerance       1e-06;
        relTol          0.01;
        smoother        GaussSeidel;
    }

    "(U|k|omega)"
    {
        solver          smoothSolver;
        smoother        symGaussSeidel;
        tolerance       1e-07;
        relTol          0.1;
    }
}

SIMPLE
{
    nNonOrthogonalCorrectors 0;
    consistent      yes;
    
    residualControl
    {
        p               1e-4;
        U               1e-4;
        "(k|omega)"     1e-4;
    }
}

relaxationFactors
{
    fields
    {
        p               0.3;        // Pressure relaxation
    }
    equations
    {
        U               0.7;        // Velocity relaxation
        k               0.7;
        omega           0.7;
    }
}
```

---

### 4. Running Simulations

**Basic Execution:**
```bash
# Single-core run
simpleFoam > log.simpleFoam 2>&1

# Parallel run (4 cores)
decomposePar
mpirun -np 4 simpleFoam -parallel > log.simpleFoam 2>&1
reconstructPar
```

**Monitor Progress:**
```bash
# Watch log file
tail -f log.simpleFoam

# Plot residuals
foamLog log.simpleFoam
gnuplot
> plot './logs/p_0' with lines
```

**What to Watch For:**
- ✅ Residuals decreasing steadily
- ✅ Values reaching < 1e-4 for good convergence
- ❌ Divergence (residuals increasing)
- ❌ NaN values (indicates instability)
- ❌ Very slow convergence (may need adjustment)

**Typical Issues & Solutions:**

| Problem | Solution |
|---------|----------|
| Divergence | Reduce relaxation factors |
| Slow convergence | Increase relaxation (carefully) |
| Non-physical results | Check boundary conditions |
| High residuals stuck | Check mesh quality |

---

### 5. Post-Processing

#### 5a. OpenFOAM Built-in Functions
```bash
# Calculate derived quantities
postProcess -func 'mag(U)'              # Velocity magnitude
postProcess -func 'components(U)'       # Ux, Uy, Uz
postProcess -func pressureDrop          # Pressure difference
postProcess -func wallShearStress       # Wall shear
```

#### 5b. ParaView Visualization
```bash
# Create .foam file
touch case.foam
paraview case.foam &

# Or use paraFoam utility
paraFoam
```

**In ParaView:**
1. Click "Apply" to load data
2. Select variable to visualize (U, p, k, etc.)
3. Add filters: Slice, Streamlines, Glyphs
4. Save images/animations

#### 5c. Python Analysis

**Example: Extract and plot residuals**
```python
import pandas as pd
import matplotlib.pyplot as plt

# Read residuals
data = pd.read_csv('postProcessing/residuals/0/residuals.dat', 
                   sep='\s+', comment='#')

# Plot
plt.figure(figsize=(10, 6))
plt.semilogy(data['Time'], data['Ux'], label='Ux')
plt.semilogy(data['Time'], data['p'], label='p')
plt.xlabel('Iteration')
plt.ylabel('Residual')
plt.legend()
plt.grid(True)
plt.savefig('residuals.png', dpi=300)
```

**Example: Calculate power number**
```python
import numpy as np

# Read forces on rotating zone
# Calculate torque
# Power = Torque × omega
# Power number = P / (rho × N³ × D⁵)

rho = 1000  # kg/m³
N = 100/60  # rev/s
D = 0.1     # m

P = calculate_power_from_forces()  # Your function
Np = P / (rho * N**3 * D**5)

print(f"Power number: {Np:.3f}")
```

---

### 6. Validation

**Always Validate Against:**
- Published experimental data
- Empirical correlations
- Analytical solutions
- Other CFD studies

**For Stirred Tanks:**

**Power Number Correlation (Rushton turbine):**
```
Np = 5.0 (for Re > 10,000)
```

**Mixing Time Correlation:**
```
θm × N = 4.0 - 6.0 (dimensionless)
```

**Validation Checklist:**
- ✅ Mesh independence (< 5% change with refinement)
- ✅ Physical behavior (velocity profiles reasonable)
- ✅ Quantitative metrics match literature
- ✅ Energy balance closed
- ✅ Mass conservation satisfied

---

## Key Files Reference

### blockMeshDict Structure
```cpp
/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  11                                    |
|   \\  /    A nd           | Web:      www.OpenFOAM.org                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/
FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    object      blockMeshDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

convertToMeters 1;

vertices
(
    // Define vertex coordinates
    (x0 y0 z0)  // vertex 0
    (x1 y1 z1)  // vertex 1
    // ...
);

blocks
(
    hex (0 1 2 3 4 5 6 7)  // vertex indices
    (nx ny nz)              // cell divisions
    simpleGrading (1 1 1)   // cell expansion ratios
);

edges
(
    // Define curved edges (arcs, splines)
    arc 0 1 (xm ym zm)
);

boundary
(
    walls
    {
        type wall;
        faces
        (
            (0 1 2 3)
            // ...
        );
    }
    
    inlet
    {
        type patch;
        faces
        (
            (4 5 6 7)
        );
    }
);

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //
```

### Allrun Script Template
```bash
#!/bin/sh
cd ${0%/*} || exit 1    # Run from case directory
. $WM_PROJECT_DIR/bin/tools/RunFunctions

# Source tutorial run functions
application=$(getApplication)

# Restore clean 0/ directory
restore0Dir

# Generate mesh
runApplication blockMesh
runApplication checkMesh

# Run simulation
runApplication $application

# Post-processing
runApplication postProcess -func 'mag(U)'
python3 ../../scripts/postprocessing/calculate_metrics.py

echo ""
echo "Simulation complete! Results in postProcessing/"
echo ""
```

### Allclean Script Template
```bash
#!/bin/sh
cd ${0%/*} || exit 1
. $WM_PROJECT_DIR/bin/tools/CleanFunctions

# Clean case
cleanCase

# Remove generated files
rm -rf 0
rm -rf postProcessing
rm -rf processor*
rm -rf *.foam
rm -rf log.*

echo "Case cleaned!"
```

---

## Debugging Guide

### Common Problems & Solutions

#### 1. Mesh Quality Issues

**Problem:** checkMesh reports errors

**Diagnosis:**
```bash
checkMesh -allTopology -allGeometry
```

**Common Issues:**

| Error | Cause | Fix |
|-------|-------|-----|
| Negative volume | Vertices wrong order | Reorder vertices in blockMeshDict |
| High non-orthogonality | Poor cell shape | Adjust block structure, add grading |
| High aspect ratio | Cells too stretched | Reduce cell count ratio |

#### 2. Divergence

**Problem:** Simulation crashes or produces NaN

**Diagnosis:**
```bash
tail -50 log.simpleFoam
# Look for "FOAM FATAL ERROR" or residuals -> inf
```

**Solutions:**
1. **Reduce relaxation factors** (fvSolution):
```cpp
   relaxationFactors
   {
       fields { p 0.2; }        // Was 0.3
       equations { U 0.5; }      // Was 0.7
   }
```

2. **Check boundary conditions:**
   - Ensure inlet velocity is reasonable
   - Check for conflicting BCs

3. **Improve initial guess:**
   - Use potentialFoam first
   - Start from coarser mesh solution

4. **Use more stable schemes** (fvSchemes):
```cpp
   divSchemes
   {
       div(phi,U)  bounded Gauss upwind;  // More stable
   }
```

#### 3. Slow Convergence

**Problem:** Residuals plateau above target

**Solutions:**
1. **Increase relaxation** (carefully):
```cpp
   relaxationFactors
   {
       equations { U 0.8; }  // Was 0.7
   }
```

2. **Check for recirculation:**
   - May need transient simulation
   - Ensure outlet is far enough downstream

3. **Verify mesh quality:**
   - High skewness slows convergence

#### 4. Non-Physical Results

**Problem:** Results look wrong (backward flow, unrealistic values)

**Checklist:**
- ✅ Units correct in all files?
- ✅ Boundary conditions physical?
- ✅ Material properties correct?
- ✅ Rotation direction correct (MRF)?
- ✅ Mesh refined enough?

---

## Independence Checklist

### Before Starting Each Case

- [ ] Understand the physics being modeled
- [ ] Sketch geometry on paper
- [ ] Identify key boundaries
- [ ] Research validation data

### During Setup

- [ ] Start from working template (previous case or tutorial)
- [ ] Modify one thing at a time
- [ ] Check mesh quality before running
- [ ] Verify boundary conditions are physical

### During Simulation

- [ ] Monitor residuals regularly
- [ ] Check for warnings in log file
- [ ] Estimate when convergence will occur
- [ ] Have backup plan if diverges

### After Simulation

- [ ] Visualize in ParaView - does it look right?
- [ ] Extract key metrics
- [ ] Compare to validation data
- [ ] Document findings in README
- [ ] Commit to Git

### Becoming Independent

**Use these resources:**

1. **OpenFOAM Tutorials:**
```bash
   cd /opt/openfoam11/tutorials
   find . -name "*keyword*"
```

2. **OpenFOAM Documentation:**
   - https://www.openfoam.com/documentation/user-guide
   - https://www.openfoam.org/version/11/

3. **CFD Online Forums:**
   - https://www.cfd-online.com/Forums/openfoam/
   - Search before asking

4. **Your Previous Cases:**
   - Copy and modify working cases
   - Build your own template library

**Search Strategy:**
- "OpenFOAM [what you want]"
- Example: "OpenFOAM MRF stirred tank setup"
- Example: "OpenFOAM k-omega SST boundary conditions"

---

## Quick Command Reference

### Essential Commands
```bash
# Environment
conda activate bioreactor
cd ~/projects/bioreactor-cfd

# Mesh operations
blockMesh                        # Generate mesh
checkMesh                        # Check quality
checkMesh -allTopology          # Detailed check

# Running
simpleFoam                       # Steady-state incompressible
pimpleFoam                       # Transient incompressible
./Allrun                         # Run entire case
./Allclean                       # Clean case

# Parallel
decomposePar                     # Decompose for parallel
mpirun -np 4 simpleFoam -parallel
reconstructPar                   # Reconstruct after parallel

# Visualization
paraFoam                         # Open in ParaView
touch case.foam; paraview case.foam &

# Post-processing
postProcess -func 'mag(U)'
postProcess -list                # List available functions
foamLog log.simpleFoam          # Extract residuals

# Utilities
foamListTimes                    # List time directories
foamDictionary -entry boundaryField 0/U  # Query dictionary
```

### File Operations
```bash
# Copy initial conditions
cp -r 0.orig 0
restore0Dir                      # From Allrun script

# View OpenFOAM file
cat 0/U
nano system/controlDict

# Find tutorials
find /opt/openfoam11/tutorials -name "*stirred*"
```

### Git Workflow
```bash
# Regular workflow
git status
git add cases/01_stirred_tank/
git commit -m "Add validated stirred tank case"
git push

# Branching for experiments
git checkout -b experiment-new-impeller
# Make changes, test
git checkout main              # Back to stable
git merge experiment-new-impeller  # If successful
```

---

## Development Philosophy

### Start Simple
```
Simple geometry → Complex geometry
Coarse mesh → Fine mesh
Steady-state → Transient
Single-phase → Multiphase
Known validation → New problems
```

### Iterate Systematically

1. ✅ Get something running (even if inaccurate)
2. ✅ Verify it doesn't crash
3. ✅ Check it gives reasonable results
4. ✅ Refine and improve
5. ✅ Validate thoroughly
6. ✅ Document and commit

**Not:** Try to build perfect case before first run

### Build Your Library

Every working case is a template for the next one:
```
cases/
├── 01_stirred_tank_basic/     # Your first template
├── 02_stirred_tank_baffles/   # Add complexity
├── 03_stirred_tank_multiphase/
└── ...
```

Copy, modify, improve!

---

## Next Steps

### Immediate (Phase 1)
1. Create basic stirred tank case
2. Validate power number
3. Document workflow
4. Commit to GitHub

### Short-term (Phase 2)
1. Add baffles
2. Implement Lagrangian particle tracking
3. Multiphase (gas-liquid)
4. Scale-up study

### Long-term (Phase 3)
1. Bubble column
2. Cell damage modeling
3. Optimization studies
4. Real bioprocess integration

---

## Useful Equations

### Dimensionless Numbers

**Reynolds Number:**
```
Re = (ρ N D²) / μ
```
- N = rotational speed (rev/s)
- D = impeller diameter (m)
- ρ = density (kg/m³)
- μ = dynamic viscosity (Pa·s)

**Power Number:**
```
Np = P / (ρ N³ D⁵)
```
- P = power (W)
- Typical for Rushton: Np ≈ 5.0 (turbulent regime)

**Mixing Time:**
```
θm × N = 4-6 (dimensionless)
```
- θm = mixing time (s)

**Gas Mass Transfer (kLa):**
```
kLa = (OTR) / (C* - CL)
```
- OTR = oxygen transfer rate
- C* = saturation concentration
- CL = liquid concentration

### Fluid Properties (Water at 20°C)
```
ρ = 1000 kg/m³
μ = 0.001 Pa·s  
ν = 1e-6 m²/s
```

---

## Tips for Success

1. **Document as you go** - You'll forget details quickly
2. **Commit often** - Small, logical commits
3. **Test incrementally** - Don't change everything at once
4. **Keep learning** - Read tutorials, forums, papers
5. **Be patient** - CFD has a learning curve
6. **Ask for help** - Community is helpful if you show effort
7. **Validate always** - Never trust results without validation

---

## Contact & Resources

**Your Project:**
- GitHub: github.com/jonruh08/bioreactor-cfd
- Local: ~/projects/bioreactor-cfd

**Official Resources:**
- OpenFOAM.org: https://www.openfoam.org
- OpenFOAM.com: https://www.openfoam.com
- CFD Online: https://www.cfd-online.com/Forums/openfoam/

**This Guide:**
- Created: October 21, 2025
- Author: jonruh08
- Version: 1.0
- Location: ~/projects/bioreactor-cfd/docs/workflow_guide.md

---

*Good luck with your CFD journey! Remember: Every expert was once a beginner who didn't give up.*
